<div class="sala-container" *ngIf="!carregando; else loadingTpl"
  [ngClass]="{ 'revisao-foco': modo === 'revisar' && modoRevisaoFocoAtivo }">

  <!-- CABE√áALHO DA SALA -->
  <section class="card sala-header">
    <div class="sala-header-esquerda">
      <p class="sala-subtitulo">Sala de estudo</p>
      <h1 class="sala-titulo">
        {{ materia?.nome || 'Mat√©ria' }}
      </h1>
      <div class="sala-descricao" *ngIf="materia">
        Foque seus estudos, fa√ßa anota√ß√µes e acompanhe o tempo dedicado a esta mat√©ria.
      </div>
    </div>
    <div>




  
    </div>
  </section>



  <!-- CORPO DA SALA -->
  <section class="card sala-body">

    <!-- COLUNA ESQUERDA: LISTA DE T√ìPICOS -->
    <aside class="coluna-esquerda">
      <div class="coluna-header">
        <h2>T√≥picos da mat√©ria</h2>
        <p class="hint">
          Clique em um t√≥pico para focar o estudo.
        </p>
      </div>

      <!-- LISTA HIER√ÅRQUICA -->
      <ul class="lista-topicos" *ngIf="topicos && topicos.length; else semTopicos">
        <li *ngFor="let t of topicos" class="item-topico" [class.topico-pai]="t.hasFilhos"
          [class.selecionado]="!t.hasFilhos && topicoSelecionado?.id === t.id"
          (click)="!t.hasFilhos && selecionarTopico(t)">

          <div class="linha-topico" [style.paddingLeft.px]="(t.nivel || 0) * 20">
            <span class="badge-nivel" [ngClass]="classeSemaforoRevisaoSala(t)"></span>
            <span class="descricao-topico">
              {{ t.descricao }}
            </span>
          </div>
        </li>
      </ul>

      <ng-template #semTopicos>
        <p class="muted">
          Esta mat√©ria ainda n√£o possui t√≥picos cadastrados.
          <br>
          Volte ao cadastro de mat√©rias para criar sua √°rvore de t√≥picos.
        </p>
      </ng-template>
    </aside>

    <!-- COLUNA DIREITA: CONTE√öDO DA SALA -->
    <main class="coluna-direita">

      <!-- Abas do modo -->
      <div class="abas-modo">
        <div class="botoes">
          <button type="button" class="aba" [class.ativa]="modo === 'estudar'" (click)="mudarModo('estudar')">
            Estudar
          </button>

          <button type="button" class="aba" [class.ativa]="modo === 'revisar'" (click)="mudarModo('revisar')">
            Revisar
          </button>

         
        </div>
        <div class="icones-sons">
          <button type="button" class="som-icone" *ngFor="let som of sonsFoco" [class.ativo]="somAtivoId === som.id"
            (click)="onClickSomIcone(som.id)" [title]="som.nome">
            <img class="som-icone-img" [src]="som.icone" [alt]="som.nome" />
            <span class="som-icone-nome">{{ som.nome }}</span>
          </button>
        </div>
      </div>

      <!-- ===================== MODO ESTUDAR ===================== -->
      <section *ngIf="modo === 'estudar'" class="modo-conteudo">

        <ng-template #selecioneTopico>
          <h2 class="titulo-section">
            Selecione um t√≥pico ao lado para come√ßar a estudar.
          </h2>
        </ng-template>

        <div class="bloco bloco-anotacoes">

          <div class="timer-botoes">
            <div *ngIf="topicoSelecionado; else selecioneTopico">
              <h2 class="titulo-section">
                Estudando:
                <span>{{ topicoSelecionado.descricao }}</span>
              </h2>
            </div>

            <div class="timer-modos">
              <button type="button" class="btn-modo-timer" [class.ativo]="modoTemporizador === 'livre'"
                (click)="setModoTemporizador('livre')">
                ‚è± Livre
              </button>

              <button type="button" class="btn-modo-timer" [class.ativo]="modoTemporizador === 'pomodoro'"
                (click)="setModoTemporizador('pomodoro')">
                üçÖ Pomodoro
              </button>
            </div>
          </div>

          <!-- AVISO QUANDO N√ÉO PODE EDITAR -->
          <div class="editor-aviso" *ngIf="!topicoSelecionado || !topicoPermiteEstudo || !timerAtivo">
            <span class="editor-aviso-icon">üîí</span>
            <div class="editor-aviso-texto">
              <strong>Editor bloqueado</strong>

              <span *ngIf="!topicoSelecionado">
                Selecione um t√≥pico na coluna √† esquerda para come√ßar.
              </span>

              <span *ngIf="topicoSelecionado && topicoSelecionado.hasFilhos">
                Este t√≥pico possui subt√≥picos. Selecione um subt√≥pico espec√≠fico para registrar o estudo.
              </span>

              <span *ngIf="topicoPermiteEstudo && !timerAtivo">
                Inicie o cron√¥metro para liberar as anota√ß√µes deste t√≥pico.
              </span>
            </div>
          </div>

          <!-- Editor -->
          <div class="editor-wrapper">
            <p-editor id="anotacoes" [(ngModel)]="anotacoes" name="anotacoes"
              [readonly]="!topicoPermiteEstudo || !timerAtivo">
            </p-editor>
          </div>

          <div class="timer-header-linha">
            <div class="botoes-do-timer">
              <button type="button" class="btn primario" (click)="toggleTimer()"
                [disabled]="!topicoSelecionado || !topicoPermiteEstudo">
                {{ timerAtivo ? 'Pausar' : 'Iniciar' }}
              </button>

              <button type="button" class="btn secundario" (click)="zerarTimer()" [disabled]="(!tempoTotalSegundos && modoTemporizador === 'livre')
                  || (modoTemporizador === 'pomodoro' && pomodoroSegundosRestantes === duracaoFaseAtual)">
                Zerar
              </button>
            </div>

            <div class="timer-header-textos">
              <span class="timer-label">
                {{ modoTemporizador === 'livre' ? 'Tempo de estudo' : 'Pomodoro' }}
                <ng-container *ngIf="modoTemporizador === 'pomodoro'">
                  ‚Äì <span class="timer-fase-inline">{{ labelFasePomodoro }}</span>
                </ng-container>
                ¬∑ {{ tempoFormatado }}
              </span>
            </div>
          </div>
        </div>

        <!-- A√á√ïES DO ESTUDO -->
        <div class="acoes-estudo">
          <button type="button" class="btn primario" [disabled]="!topicoPermiteEstudo" (click)="salvarEstudo()">
            Salvar estudo
          </button>

          <button type="button" class="btn secundario" (click)="abrirModalFlashcard()"
            [disabled]="!topicoPermiteEstudo">
            + Criar flashcard
          </button>

          <span class="salvo-msg" *ngIf="mensagemEstudoSalvo">
            {{ mensagemEstudoSalvo }}
          </span>
        </div>

      </section>

      <!-- ===================== MODO REVISAR ===================== -->
      <section *ngIf="modo === 'revisar'" class="modo-conteudo">

        <div class="cabecalho-revisao">
          <div>
            <button type="button" class="btn fantasma" *ngIf="!modoRevisaoFocoAtivo" (click)="ativarModoFocoRevisao()">
              üßò‚Äç‚ôÇÔ∏è Ativar modo foco
            </button>

            <button type="button" class="btn secundario" *ngIf="modoRevisaoFocoAtivo" (click)="sairModoFocoRevisao()">
              ‚Üê Sair do modo foco
            </button>

            <p class="muted pequeno">
              Mat√©ria: <strong>{{ materia?.nome || '-' }}</strong> ‚Ä¢
              T√≥pico: <strong>{{ topicoSelecionado?.descricao || '-' }}</strong>
            </p>
          </div>

          <!-- Alternador de tipo de revis√£o -->
          <div class="toggle-revisao">
            <button type="button" class="toggle-btn" [class.ativo]="modoRevisao === 'anotacoes'"
              (click)="modoRevisao = 'anotacoes'">
              üìù Anota√ß√µes / Resumo
            </button>

            <button type="button" class="toggle-btn" [class.ativo]="modoRevisao === 'flashcards'"
              (click)="ativarRevisaoFlashcards()">
              üÉè Flashcards
            </button>

          </div>
        </div>

         <div class="alerta-revisao" *ngIf="mensagemRevisao">
    <span class="alerta-revisao-icone">‚úî</span>
    <span class="alerta-revisao-texto">{{ mensagemRevisao }}</span>
  </div>

        <!-- REVIS√ÉO POR ANOTA√á√ïES -->
        <div *ngIf="modoRevisao === 'anotacoes'" class="bloco bloco-revisao-anotacoes">

          <ng-container *ngIf="anotacoes && anotacoes.trim(); else semAnotacoesTpl">
            <h3 class="subtitulo-section">Anota√ß√µes deste t√≥pico</h3>

            <!-- Renderiza o HTML vindo do editor -->
            <div class="anotacoes-renderizadas" [innerHTML]="anotacoesHtmlSeguras">
            </div>

            <!-- AVALIA√á√ÉO DA REVIS√ÉO DAS ANOTA√á√ïES -->
            <div class="revisao-anotacoes-feedback">
              <p class="muted pequeno">
                Como foi revisar essas anota√ß√µes?
              </p>
              <div class="botoes-avaliacao">
                <button type="button" class="btn secundario" (click)="avaliarRevisaoAnotacao('ERREI')">
                  Errei / N√£o lembrei
                </button>
                <button type="button" class="btn secundario" (click)="avaliarRevisaoAnotacao('DIFICIL')">
                  Lembrei com dificuldade
                </button>
                <button type="button" class="btn secundario" (click)="avaliarRevisaoAnotacao('BOM')">
                  Lembrei bem
                </button>
                <button type="button" class="btn secundario" (click)="avaliarRevisaoAnotacao('FACIL')">
                  Muito f√°cil
                </button>
              </div>
            </div>

          </ng-container>

          <ng-template #semAnotacoesTpl>
            <div class="painel-revisao-placeholder">
              <p>
                N√£o h√° anota√ß√µes salvas para este t√≥pico ainda.<br>
                Use o modo <strong>Estudar</strong> para registrar um resumo ou pontos importantes.
              </p>
            </div>
          </ng-template>

        </div>

        <!-- REVIS√ÉO POR FLASHCARDS -->
        <div *ngIf="modoRevisao === 'flashcards'" class="bloco bloco-revisao-flashcards">

          <h3 class="subtitulo-section">Revis√£o com flashcards</h3>
          <p class="muted pequeno">
            Treine lembran√ßa ativa: tente responder antes de virar o cart√£o.
          </p>

          <!-- LOADING / ERRO DA REVIS√ÉO -->
          <div *ngIf="carregandoFlashcardsRevisao" class="painel-revisao-placeholder">
            <p>Carregando flashcards para revis√£o...</p>
          </div>

          <div *ngIf="!carregandoFlashcardsRevisao && erroFlashcardsRevisao" class="painel-revisao-placeholder">
            <p>{{ erroFlashcardsRevisao }}</p>
          </div>

          <!-- NENHUM FLASHCARD -->
          <div *ngIf="!carregandoFlashcardsRevisao && (!flashcards || !flashcards.length)"
            class="painel-revisao-placeholder">
            <p>
              Nenhum flashcard cadastrado para este t√≥pico ainda.<br>
              No modo <strong>Estudar</strong>, use o bot√£o ‚ÄúCriar Flashcard‚Äù
              para transformar partes importantes em cart√µes de revis√£o.
            </p>
          </div>

          <!-- FLASHCARD ATUAL -->
          <div *ngIf="!carregandoFlashcardsRevisao && flashcardAtual" class="flashcard-review-container">

            <!-- Cart√£o estilo Anki -->
            <div class="flashcard-card-review" [ngClass]="{ 'frente': !mostrarVersoAtual, 'verso': mostrarVersoAtual }"
              (click)="virarFlashcard()">

              <div class="flashcard-card-header-linha">
                <span class="face-pill">
                  {{ mostrarVersoAtual ? 'Verso (resposta)' : 'Frente (pergunta)' }}
                </span>

                <span class="meta-contagem" *ngIf="flashcards?.length">
                  {{ flashcardIndexAtual + 1 }} / {{ flashcards.length }}
                </span>
              </div>

              <div class="flashcard-card-corpo">
                <div class="flashcard-conteudo-review">
                  {{ mostrarVersoAtual ? flashcardAtual?.verso : flashcardAtual?.frente }}
                </div>
              </div>

              <div class="flashcard-card-footer-linha">
                <span class="meta-dificuldade">
                  Dificuldade: {{ flashcardAtual?.dificuldade || 'MEDIA' }}
                </span>

                <span class="meta-tags" *ngIf="flashcardAtual?.tags">
                  {{ flashcardAtual.tags }}
                </span>

                <span class="meta-hint">
                  Clique para {{ mostrarVersoAtual ? 'ver a frente' : 'ver a resposta' }}.
                </span>
              </div>
            </div>

            <div class="flashcard-acoes-review">
              <button type="button" class="btn secundario" (click)="anteriorFlashcard()">
                ‚óÄ Anterior
              </button>

              <button type="button" class="btn primario" (click)="virarFlashcard()">
                {{ mostrarVersoAtual ? 'Voltar para a frente' : 'Mostrar resposta' }}
              </button>

              <button type="button" class="btn secundario" (click)="proximoFlashcard()">
                Pr√≥ximo ‚ñ∂
              </button>
            </div>

            <!-- AVALIA√á√ÉO DA REVIS√ÉO DO FLASHCARD -->
            <div class="flashcard-feedback-review">
              <p class="muted pequeno">
                Como foi lembrar a resposta deste flashcard?
              </p>
              <div class="botoes-avaliacao">
                <button type="button" class="btn secundario" (click)="avaliarFlashcard('ERREI')">
                  Errei / N√£o lembrei
                </button>
                <button type="button" class="btn secundario" (click)="avaliarFlashcard('DIFICIL')">
                  Lembrei com dificuldade
                </button>
                <button type="button" class="btn secundario" (click)="avaliarFlashcard('BOM')">
                  Lembrei bem
                </button>
                <button type="button" class="btn secundario" (click)="avaliarFlashcard('FACIL')">
                  Muito f√°cil
                </button>
              </div>
            </div>
          </div>

        </div>

      </section>

    </main>
  </section>

  <!-- =============== MODAL DE FLASHCARD =============== -->
  <div class="flashcard-overlay" *ngIf="mostrarModalFlashcard">
    <div class="flashcard-modal">

      <header class="flashcard-header">
        <div>
          <h2 class="flashcard-titulo">Criar Flashcard</h2>
          <p class="flashcard-subtitulo">
            Transforme o que voc√™ acabou de estudar em perguntas r√°pidas para revisar depois.
          </p>
        </div>

        <button type="button" class="flashcard-fechar" (click)="fecharModalFlashcard()">
          ‚úï
        </button>
      </header>

      <!-- Bloco com contexto (Mat√©ria / T√≥pico) -->
      <div class="flashcard-contexto">
        <div class="flashcard-contexto-linha">
          <span class="contexto-label">Mat√©ria:</span>
          <span class="contexto-valor">{{ materia?.nome || '-' }}</span>
        </div>
        <div class="flashcard-contexto-linha">
          <span class="contexto-label">T√≥pico:</span>
          <span class="contexto-valor">
            {{ topicoSelecionado?.descricao || '-' }}
          </span>
        </div>
      </div>

      <!-- Frente / Verso -->
      <div class="flashcard-campos">
        <label class="flashcard-label">
          Frente (pergunta)
          <textarea rows="3" class="flashcard-textarea" [(ngModel)]="flashcardFrente" name="flashcardFrente"
            placeholder="Digite a pergunta..."></textarea>
        </label>

        <label class="flashcard-label">
          Verso (resposta)
          <textarea rows="3" class="flashcard-textarea" [(ngModel)]="flashcardVerso" name="flashcardVerso"
            placeholder="Digite a resposta..."></textarea>
        </label>
      </div>

      <!-- Tipo / Dificuldade -->
      <div class="flashcard-linha-dupla">
        <label class="flashcard-label">
          Tipo
          <select class="flashcard-select" [(ngModel)]="flashcardTipo" name="flashcardTipo">
            <option value="PERGUNTA_RESPOSTA">Pergunta e resposta</option>
            <option value="VERDADEIRO_FALSO">Verdadeiro ou falso</option>
            <option value="CLOZE">Cloze (preencher lacuna)</option>
          </select>
        </label>

        <label class="flashcard-label">
          Dificuldade
          <select class="flashcard-select" [(ngModel)]="flashcardDificuldade" name="flashcardDificuldade">
            <option value="FACIL">F√°cil</option>
            <option value="MEDIA">M√©dia</option>
            <option value="DIFICIL">Dif√≠cil</option>
          </select>
        </label>
      </div>

      <!-- Tags -->
      <div class="flashcard-tags-wrapper">
        <label class="flashcard-label">
          Tags (opcional)
          <input type="text" class="flashcard-input" [(ngModel)]="flashcardTags" name="flashcardTags"
            placeholder="Ex.: portugu√™s, morfologia, substantivo" />
        </label>
        <small class="flashcard-dica">
          Dica: use tags para encontrar depois todos os flashcards relacionados a um tema.
        </small>
      </div>

      <div *ngIf="mensagemFlashcardSucesso" class="flashcard-mensagem-sucesso">
        {{ mensagemFlashcardSucesso }}
      </div>

      <!-- Rodap√© -->
      <footer class="flashcard-footer">
        <button type="button" class="btn secundario" (click)="fecharModalFlashcard()">
          Cancelar
        </button>

        <button type="button" class="btn primario" (click)="salvarFlashcard()"
          [disabled]="!flashcardFrente.trim() || !flashcardVerso.trim()">
          üíæ Salvar Flashcard
        </button>
      </footer>

    </div>
  </div>
  <!-- =============== FIM MODAL =============== -->

</div>

<ng-template #loadingTpl>
  <div class="sala-loading">
    Carregando sala de estudo...
  </div>
</ng-template>

<div *ngIf="erro" class="mensagem-erro">
  {{ erro }}
</div>