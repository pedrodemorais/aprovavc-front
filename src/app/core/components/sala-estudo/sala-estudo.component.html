<div class="sala-container" *ngIf="!carregando; else loadingTpl">

  <!-- CABE√áALHO DA SALA -->
  <section class="card sala-header">
    <div class="sala-header-esquerda">
      <p class="sala-subtitulo">Sala de estudo</p>
      <h1 class="sala-titulo">
        {{ materia?.nome || 'Mat√©ria' }}
      </h1>
      <p class="sala-descricao" *ngIf="materia">
        Foque seus estudos, fa√ßa anota√ß√µes e acompanhe o tempo dedicado a esta mat√©ria.
      </p>
    </div>

    <div class="sala-header-direita">

      <!-- MODOS DO TIMER: LIVRE x POMODORO -->
      <div class="timer-modos">
        <button type="button" class="btn-modo-timer" [class.ativo]="modoTemporizador === 'livre'"
          (click)="setModoTemporizador('livre')">
          ‚è± Livre
        </button>

        <button type="button" class="btn-modo-timer" [class.ativo]="modoTemporizador === 'pomodoro'"
          (click)="setModoTemporizador('pomodoro')">
          üçÖ Pomodoro
        </button>
      </div>

      <div class="timer-box">
     <div class="timer-header-linha">
  <div class="timer-header-textos">
    <span class="timer-label">
      {{ modoTemporizador === 'livre' ? 'Tempo de estudo' : 'Pomodoro' }}
      <ng-container *ngIf="modoTemporizador === 'pomodoro'">
        ‚Äì <span class="timer-fase-inline">{{ labelFasePomodoro }}</span>
      </ng-container>
    </span>
  </div>
</div>


        <!-- VALOR DO TIMER (formata√ß√£o vem do TS) -->
        <span class="timer-valor">{{ tempoFormatado }}</span>

        <div class="timer-botoes">
          <button type="button" class="btn primario" (click)="toggleTimer()">
            {{ timerAtivo ? 'Pausar' : 'Iniciar' }}
          </button>
          <button type="button" class="btn secundario" (click)="zerarTimer()" [disabled]="(!tempoTotalSegundos && modoTemporizador === 'livre')
                              || (modoTemporizador === 'pomodoro' && pomodoroSegundosRestantes === duracaoFaseAtual)">
            Zerar
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- CORPO DA SALA -->
  <section class="card sala-body">

    <!-- COLUNA ESQUERDA: LISTA DE T√ìPICOS -->
    <aside class="coluna-esquerda">
      <div class="coluna-header">
        <h2>T√≥picos da mat√©ria</h2>
        <p class="hint">
          Clique em um t√≥pico para focar o estudo.
        </p>
      </div>

      <!-- LISTA HIER√ÅRQUICA -->
      <ul class="lista-topicos" *ngIf="topicos && topicos.length; else semTopicos">
        <li *ngFor="let t of topicos" class="item-topico" (click)="selecionarTopico(t)"
          [class.selecionado]="topicoSelecionado?.id === t.id">

          <div class="linha-topico" [style.paddingLeft.px]="(t.nivel || 0) * 20">
            <span class="marcador-nivel" [ngClass]="'nivel-' + (t.nivel || 0)"></span>
            <span class="descricao-topico">
              {{ t.descricao }}
            </span>
          </div>
        </li>
      </ul>

      <ng-template #semTopicos>
        <p class="muted">
          Esta mat√©ria ainda n√£o possui t√≥picos cadastrados.
          <br>
          Volte ao cadastro de mat√©rias para criar sua √°rvore de t√≥picos.
        </p>
      </ng-template>
    </aside>

    <!-- COLUNA DIREITA: CONTE√öDO DA SALA -->
    <main class="coluna-direita">

      <!-- Abas do modo -->
      <div class="abas-modo">
        <button type="button" class="aba" [class.ativa]="modo === 'estudar'" (click)="mudarModo('estudar')">
          Estudar
        </button>

        <button type="button" class="aba" [class.ativa]="modo === 'revisar'" (click)="mudarModo('revisar')">
          Revisar
        </button>
      </div>

      <!-- MODO ESTUDAR -->
      <section *ngIf="modo === 'estudar'" class="modo-conteudo">

        <ng-template #selecioneTopico>
          <h2 class="titulo-section">
            Selecione um t√≥pico ao lado para come√ßar a estudar.
          </h2>
        </ng-template>

        <div class="bloco bloco-anotacoes">
          <div *ngIf="topicoSelecionado; else selecioneTopico">
            <h2 class="titulo-section">
              Estudando:
              <span>{{ topicoSelecionado.descricao }}</span>
            </h2>
          </div>

          <!-- wrapper que vai crescer e empurrar o editor pra ocupar tudo -->
          <div class="editor-wrapper">
            <p-editor
              id="anotacoes"
              [(ngModel)]="anotacoes"
              name="anotacoes">
            </p-editor>
          </div>
        </div>

        <!-- üîπ A√á√ïES DO ESTUDO -->
        <div class="acoes-estudo">
          <button
            type="button"
            class="btn primario"
            [disabled]="!topicoSelecionado"
            (click)="salvarEstudo()">
            Salvar estudo
          </button>
          <button
            type="button"
            class="btn primario"
            [disabled]="!topicoSelecionado"
            (click)="salvarEstudo()">
            Criar Flashcards
          </button>

          <span class="salvo-msg" *ngIf="mensagemEstudoSalvo">
            {{ mensagemEstudoSalvo }}
          </span>
        </div>

      </section>

      <!-- MODO REVISAR -->
      <section *ngIf="modo === 'revisar'" class="modo-conteudo">
        <h2 class="titulo-section">
          Revis√£o desta mat√©ria
        </h2>
        <p class="muted">
          Aqui voc√™ ver√° revis√µes agendadas, t√≥picos atrasados e poder√° revisar
          as anota√ß√µes e flashcards constru√≠dos no modo Estudar.
        </p>

        <div class="bloco painel-revisao-placeholder">
          <p>
            ‚Ä¢ Em breve: lista de revis√µes do dia / atrasadas / futuras.<br>
            ‚Ä¢ Atalhos para voltar diretamente para o t√≥pico a ser revisado.<br>
            ‚Ä¢ M√©tricas do progresso nessa mat√©ria.
          </p>
        </div>
      </section>

    </main>
  </section>

</div>

<ng-template #loadingTpl>
  <div class="sala-loading">
    Carregando sala de estudo...
  </div>
</ng-template>

<div *ngIf="erro" class="mensagem-erro">
  {{ erro }}
</div>
