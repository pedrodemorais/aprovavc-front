<div
  class="sala-container"
  *ngIf="!carregando; else loadingTpl"
  [ngClass]="{ 'revisao-foco': modo === 'revisar' && modoRevisaoFocoAtivo }">


  <!-- CABE√áALHO DA SALA -->
  <section class="card sala-header">
    <div class="sala-header-esquerda">
      <p class="sala-subtitulo">Sala de estudo</p>
      <h1 class="sala-titulo">
        {{ materia?.nome || 'Mat√©ria' }}
      </h1>
      <p class="sala-descricao" *ngIf="materia">
        Foque seus estudos, fa√ßa anota√ß√µes e acompanhe o tempo dedicado a esta mat√©ria.
      </p>
    </div>
  </section>

  <!-- CORPO DA SALA -->
  <section class="card sala-body">

    <!-- COLUNA ESQUERDA: LISTA DE T√ìPICOS -->
    <aside class="coluna-esquerda">
      <div class="coluna-header">
        <h2>T√≥picos da mat√©ria</h2>
        <p class="hint">
          Clique em um t√≥pico para focar o estudo.
        </p>
      </div>

      <!-- LISTA HIER√ÅRQUICA -->
      <ul class="lista-topicos" *ngIf="topicos && topicos.length; else semTopicos">
        <li
          *ngFor="let t of topicos"
          class="item-topico"
          [class.topico-pai]="t.hasFilhos"
          [class.selecionado]="!t.hasFilhos && topicoSelecionado?.id === t.id"
          (click)="!t.hasFilhos && selecionarTopico(t)">

          <div class="linha-topico" [style.paddingLeft.px]="(t.nivel || 0) * 20">
            <span class="marcador-nivel" [ngClass]="'nivel-' + (t.nivel || 0)"></span>
            <span class="descricao-topico">
              {{ t.descricao }}
            </span>
          </div>
        </li>
      </ul>

      <ng-template #semTopicos>
        <p class="muted">
          Esta mat√©ria ainda n√£o possui t√≥picos cadastrados.
          <br>
          Volte ao cadastro de mat√©rias para criar sua √°rvore de t√≥picos.
        </p>
      </ng-template>
    </aside>

    <!-- COLUNA DIREITA: CONTE√öDO DA SALA -->
    <main class="coluna-direita">

      <!-- Abas do modo -->
      <div class="abas-modo">
        <button
          type="button"
          class="aba"
          [class.ativa]="modo === 'estudar'"
          (click)="mudarModo('estudar')">
          Estudar
        </button>

        <button
          type="button"
          class="aba"
          [class.ativa]="modo === 'revisar'"
          (click)="mudarModo('revisar')">
          Revisar
        </button>
      </div>

      <!-- MODO ESTUDAR -->
      <section *ngIf="modo === 'estudar'" class="modo-conteudo">

        <ng-template #selecioneTopico>
          <h2 class="titulo-section">
            Selecione um t√≥pico ao lado para come√ßar a estudar.
          </h2>
        </ng-template>

        <div class="bloco bloco-anotacoes">

          <div class="timer-botoes">
            <div *ngIf="topicoSelecionado; else selecioneTopico">
              <h2 class="titulo-section">
                Estudando:
                <span>{{ topicoSelecionado.descricao }}</span>
              </h2>
            </div>

            <div class="timer-modos">
              <button
                type="button"
                class="btn-modo-timer"
                [class.ativo]="modoTemporizador === 'livre'"
                (click)="setModoTemporizador('livre')">
                ‚è± Livre
              </button>

              <button
                type="button"
                class="btn-modo-timer"
                [class.ativo]="modoTemporizador === 'pomodoro'"
                (click)="setModoTemporizador('pomodoro')">
                üçÖ Pomodoro
              </button>
            </div>
          </div>

          <!-- AVISO QUANDO N√ÉO PODE EDITAR -->
          <div
            class="editor-aviso"
            *ngIf="!topicoSelecionado || !topicoPermiteEstudo || !timerAtivo">
            <span class="editor-aviso-icon">üîí</span>
            <div class="editor-aviso-texto">
              <strong>Editor bloqueado</strong>

              <span *ngIf="!topicoSelecionado">
                Selecione um t√≥pico na coluna √† esquerda para come√ßar.
              </span>

              <span *ngIf="topicoSelecionado && topicoSelecionado.hasFilhos">
                Este t√≥pico possui subt√≥picos. Selecione um subt√≥pico espec√≠fico para registrar o estudo.
              </span>

              <span *ngIf="topicoPermiteEstudo && !timerAtivo">
                Inicie o cron√¥metro para liberar as anota√ß√µes deste t√≥pico.
              </span>
            </div>
          </div>

          <!-- wrapper que vai crescer e empurrar o editor pra ocupar tudo -->
          <div class="editor-wrapper">
            <p-editor
              id="anotacoes"
              [(ngModel)]="anotacoes"
              name="anotacoes"
              [readonly]="!topicoPermiteEstudo || !timerAtivo">
            </p-editor>
          </div>

          <div class="timer-header-linha">
            <div class="botoes-do-timer">
              <button
                type="button"
                class="btn primario"
                (click)="toggleTimer()"
                [disabled]="!topicoSelecionado || !topicoPermiteEstudo">
                {{ timerAtivo ? 'Pausar' : 'Iniciar' }}
              </button>

              <button
                type="button"
                class="btn secundario"
                (click)="zerarTimer()"
                [disabled]="(!tempoTotalSegundos && modoTemporizador === 'livre')
                  || (modoTemporizador === 'pomodoro' && pomodoroSegundosRestantes === duracaoFaseAtual)">
                Zerar
              </button>
            </div>

            <div class="timer-header-textos">
              <span class="timer-label">
                {{ modoTemporizador === 'livre' ? 'Tempo de estudo' : 'Pomodoro' }}
                <ng-container *ngIf="modoTemporizador === 'pomodoro'">
                  ‚Äì <span class="timer-fase-inline">{{ labelFasePomodoro }}</span>
                </ng-container>
                ¬∑ {{ tempoFormatado }}
              </span>
            </div>
          </div>
        </div>

        <!-- üîπ A√á√ïES DO ESTUDO -->
        <div class="acoes-estudo">
          <button
            type="button"
            class="btn primario"
            [disabled]="!topicoPermiteEstudo"
            (click)="salvarEstudo()">
            Salvar estudo
          </button>

        <button type="button"
        class="btn secundario"
        (click)="abrirModalFlashcard()"
        [disabled]="!topicoPermiteEstudo">
  + Criar flashcard
</button>


          <span class="salvo-msg" *ngIf="mensagemEstudoSalvo">
            {{ mensagemEstudoSalvo }}
          </span>
        </div>

      </section>

      <!-- MODO REVISAR -->
   <!-- MODO REVISAR -->
<section *ngIf="modo === 'revisar'" class="modo-conteudo">

  <div class="cabecalho-revisao">
    <div>
    
     
      <p class="muted pequeno">
        Mat√©ria: <strong>{{ materia?.nome || '-' }}</strong> ‚Ä¢
        T√≥pico: <strong>{{ topicoSelecionado?.descricao || '-' }}</strong>
      </p>
      <button
        type="button"
        class="btn fantasma"
        *ngIf="!modoRevisaoFocoAtivo"
        (click)="ativarModoFocoRevisao()">
        üßò‚Äç‚ôÇÔ∏è Ativar modo foco
      </button>

      <button
        type="button"
        class="btn secundario"
        *ngIf="modoRevisaoFocoAtivo"
        (click)="sairModoFocoRevisao()">
        ‚Üê Sair do modo foco
      </button>
    </div>
   
    <!-- Alternador de tipo de revis√£o -->
    <div class="toggle-revisao">
      <button
        type="button"
        class="toggle-btn"
        [class.ativo]="modoRevisao === 'anotacoes'"
        (click)="modoRevisao = 'anotacoes'">
        üìù Anota√ß√µes / Resumo
      </button>

      <button
        type="button"
        class="toggle-btn"
        [class.ativo]="modoRevisao === 'flashcards'"
        (click)="modoRevisao = 'flashcards'">
        üÉè Flashcards
      </button>
      
    </div>
  
  </div>

  <!-- REVIS√ÉO POR ANOTA√á√ïES -->
  <div *ngIf="modoRevisao === 'anotacoes'" class="bloco bloco-revisao-anotacoes">

    <ng-container *ngIf="anotacoes && anotacoes.trim(); else semAnotacoesTpl">
      <h3 class="subtitulo-section">Anota√ß√µes deste t√≥pico</h3>
    

      <!-- Renderiza o HTML vindo do editor (Quill / rich text) -->
    <div class="anotacoes-renderizadas"
     [innerHTML]="anotacoesHtmlSeguras">
</div>

    </ng-container>

    <ng-template #semAnotacoesTpl>
      <div class="painel-revisao-placeholder">
        <p>
          N√£o h√° anota√ß√µes salvas para este t√≥pico ainda.<br>
          Use o modo <strong>Estudar</strong> para registrar um resumo ou pontos importantes.
        </p>
      </div>
    </ng-template>

  </div>

  <!-- REVIS√ÉO POR FLASHCARDS -->
  <div *ngIf="modoRevisao === 'flashcards'" class="bloco bloco-revisao-flashcards">

    <h3 class="subtitulo-section">Revis√£o com flashcards</h3>
    <p class="muted pequeno">
      Treine lembran√ßa ativa: tente responder antes de virar o cart√£o.
    </p>

    <div *ngIf="!flashcards || !flashcards.length" class="painel-revisao-placeholder">
      <p>
        Nenhum flashcard cadastrado para este t√≥pico ainda.<br>
        No modo <strong>Estudar</strong>, use o bot√£o ‚ÄúCriar Flashcard‚Äù
        para transformar partes importantes em cart√µes de revis√£o.
      </p>
    </div>

    <div *ngIf="flashcardAtual" class="flashcard-review-container">

      <!-- Cart√£o estilo Anki -->
      <div class="flashcard-card-review" (click)="virarFlashcard()">
        <p class="flashcard-label">
          {{ mostrarVersoAtual ? 'Verso (resposta)' : 'Frente (pergunta)' }}
        </p>

        <div class="flashcard-conteudo-review">
          {{ mostrarVersoAtual ? flashcardAtual.verso : flashcardAtual.frente }}
        </div>
      </div>

      <div class="flashcard-acoes-review">
        <button type="button" class="btn secundario" (click)="anteriorFlashcard()">
          ‚óÄ Anterior
        </button>

        <button type="button" class="btn primario" (click)="virarFlashcard()">
          {{ mostrarVersoAtual ? 'Voltar para a frente' : 'Mostrar resposta' }}
        </button>

        <button type="button" class="btn secundario" (click)="proximoFlashcard()">
          Pr√≥ximo ‚ñ∂
        </button>
      </div>

      <!-- Aqui depois podemos ligar com revis√£o espa√ßada (f√°cil / m√©dio / dif√≠cil) -->
      <div class="flashcard-feedback-review">
        <span class="muted pequeno">
          Em breve: marcar se lembrou ‚Äúf√°cil / m√©dio / dif√≠cil‚Äù para alimentar a revis√£o espa√ßada.
        </span>
      </div>
    </div>

  </div>

</section>


    </main>
  </section>

  <!-- =============== MODAL DE FLASHCARD =============== -->
  <div class="flashcard-overlay" *ngIf="mostrarModalFlashcard">
    <div class="flashcard-modal">

      <header class="flashcard-header">
        <div>
          <h2 class="flashcard-titulo">Criar Flashcard</h2>
          <p class="flashcard-subtitulo">
            Transforme o que voc√™ acabou de estudar em perguntas r√°pidas para revisar depois.
          </p>
        </div>

        <button
          type="button"
          class="flashcard-fechar"
          (click)="fecharModalFlashcard()">
          ‚úï
        </button>
      </header>

      <!-- Bloco com contexto (Mat√©ria / T√≥pico) -->
      <div class="flashcard-contexto">
        <div class="flashcard-contexto-linha">
          <span class="contexto-label">Mat√©ria:</span>
          <span class="contexto-valor">{{ materia?.nome || '-' }}</span>
        </div>
        <div class="flashcard-contexto-linha">
          <span class="contexto-label">T√≥pico:</span>
          <span class="contexto-valor">
            {{ topicoSelecionado?.descricao || '-' }}
          </span>
        </div>
      </div>

      <!-- Frente / Verso -->
      <div class="flashcard-campos">
        <label class="flashcard-label">
          Frente (pergunta)
          <textarea
            rows="3"
            class="flashcard-textarea"
            [(ngModel)]="flashcardFrente"
            name="flashcardFrente"
            placeholder="Digite a pergunta..."></textarea>
        </label>

        <label class="flashcard-label">
          Verso (resposta)
          <textarea
            rows="3"
            class="flashcard-textarea"
            [(ngModel)]="flashcardVerso"
            name="flashcardVerso"
            placeholder="Digite a resposta..."></textarea>
        </label>
      </div>

      <!-- Tipo / Dificuldade -->
      <div class="flashcard-linha-dupla">
        <label class="flashcard-label">
          Tipo
          <select
            class="flashcard-select"
            [(ngModel)]="flashcardTipo"
            name="flashcardTipo">
            <option value="PERGUNTA_RESPOSTA">Pergunta e resposta</option>
            <option value="VERDADEIRO_FALSO">Verdadeiro ou falso</option>
            <option value="CLOZE">Cloze (preencher lacuna)</option>
          </select>
        </label>

        <label class="flashcard-label">
          Dificuldade
          <select
            class="flashcard-select"
            [(ngModel)]="flashcardDificuldade"
            name="flashcardDificuldade">
            <option value="FACIL">F√°cil</option>
            <option value="MEDIA">M√©dia</option>
            <option value="DIFICIL">Dif√≠cil</option>
          </select>
        </label>
      </div>

      <!-- Tags -->
      <div class="flashcard-tags-wrapper">
        <label class="flashcard-label">
          Tags (opcional)
          <input
            type="text"
            class="flashcard-input"
            [(ngModel)]="flashcardTags"
            name="flashcardTags"
            placeholder="Ex.: portugu√™s, morfologia, substantivo" />
        </label>
        <small class="flashcard-dica">
          Dica: use tags para encontrar depois todos os flashcards relacionados a um tema.
        </small>
      </div>
<div *ngIf="mensagemFlashcardSucesso" class="flashcard-mensagem-sucesso">
  {{ mensagemFlashcardSucesso }}
</div>

      <!-- Rodap√© -->
      <footer class="flashcard-footer">
        <button
          type="button"
          class="btn secundario"
          (click)="fecharModalFlashcard()">
          Cancelar
        </button>

        <button
          type="button"
          class="btn primario"
          (click)="salvarFlashcard()"
          [disabled]="!flashcardFrente.trim() || !flashcardVerso.trim()">
          üíæ Salvar Flashcard
        </button>
      </footer>

    </div>
  </div>
  <!-- =============== FIM MODAL =============== -->

</div>

<ng-template #loadingTpl>
  <div class="sala-loading">
    Carregando sala de estudo...
  </div>
</ng-template>

<div *ngIf="erro" class="mensagem-erro">
  {{ erro }}
</div>
