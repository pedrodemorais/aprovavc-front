<div class="page-container">

  <h1 class="page-title">Biblioteca de Mat√©rias</h1>

  <div class="mensagem-erro" *ngIf="mensagemErro">
    {{ mensagemErro }}
  </div>

  <div class="layout">

    <!-- COLUNA ESQUERDA: MAT√âRIA -->
    <section class="card coluna-esquerda">

      <form [formGroup]="materiaForm" (ngSubmit)="salvarMateria()" class="card-body">

        <div class="form-group">
          <label for="nome" class="titulo-topicos">
            Nome da mat√©ria <span class="obrigatorio">*</span>
          </label>
          <input
            #nomeMateriaInput
            id="nome"
            type="text"
            class="input-text"
            formControlName="nome"
            placeholder="Ex: Portugu√™s, Direito Penal, Inform√°tica..."
          />

          <div class="erro" *ngIf="campoInvalido('nome')">
            Informe o nome da mat√©ria (m√°x. 100 caracteres).
          </div>
        </div>

        <div class="acoes-form">
          <button type="submit" class="btn primario" [disabled]="salvando">
            {{ salvando ? 'Salvando...' : 'Salvar mat√©ria' }}
          </button>
        </div>

      </form>

      <hr />

      <div *ngIf="carregandoMaterias" class="loading">
        Carregando mat√©rias...
      </div>

      <table class="tabela-materias" *ngIf="!carregandoMaterias && materias.length">
        <thead>
          <tr>
            <th>Mat√©rias</th>
            <th style="width: 130px;">A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let m of materias"
            [class.selecionada]="materiaSelecionada?.id === m.id"
          >
            <td (click)="selecionarMateria(m)">{{ m.nome }}</td>
            <td class="acoes">

              <!-- üìö Sala de estudo da mat√©ria -->
              <button
                type="button"
                class="btn-icone"
                (click)="abrirSalaEstudoMateria(m)"
                title="Sala de estudo"
              >
                <img src="assets/icons/book.png" alt="Sala de estudo" class="icone-img" />
              </button>

              <!-- ‚úèÔ∏è Editar mat√©ria -->
              <button
                type="button"
                class="btn-icone"
                (click)="editarMateria(m)"
                title="Editar mat√©ria"
              >
                <img src="assets/icons/edit.png" alt="Editar mat√©ria" class="icone-img" />
              </button>

              <!-- üóëÔ∏è Excluir mat√©ria -->
              <button
                type="button"
                class="btn-icone"
                (click)="excluirMateria(m)"
                title="Excluir mat√©ria"
              >
                <img src="assets/icons/delete.png" alt="Excluir mat√©ria" class="icone-img" />
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <p *ngIf="!carregandoMaterias && !materias.length" class="vazio">
        Nenhuma mat√©ria cadastrada ainda.
      </p>
    </section>

    <!-- COLUNA DIREITA: T√ìPICOS -->
    <section class="card coluna-direita">

      <div class="card-body" *ngIf="materiaSelecionada; else selecioneMateria">

        <!-- CABE√áALHO / CONTEXTO DE T√ìPICO -->
        <div class="cabecalho-topicos">
          <div class="cabecalho-topicos-textos">
            <span *ngIf="!topicoSelecionado" class="titulo-topicos">
              T√≥picos de <span class="titulo-colorido">{{ materiaSelecionada.nome }}</span>
            </span>
            <span *ngIf="topicoSelecionado" class="titulo-topicos">
              Subt√≥picos de <span class="titulo-colorido">{{ topicoSelecionado.descricao }}</span>
            </span>

            
          </div>

          <button
            *ngIf="topicoSelecionado"
            type="button"
            class="btn secundario btn-menor"
            (click)="limparTopicoSelecionado()"
          >
            Limpar sele√ß√£o
          </button>
        </div>

        <!-- INPUT + BOT√ÉO DO T√ìPICO / SUBT√ìPICO -->
        <div class="novo-topico">
          <input
            #novoTopicoInput
            type="text"
            [(ngModel)]="novoTopicoDescricao"
            placeholder="Digite o nome do t√≥pico ou subt√≥pico..."
            class="input-text"
            name="novoTopicoDescricao"
          />

          <button
            type="button"
            class="btn primario btn-novo-topico"
            (click)="adicionarTopico()"
            title="Adicionar"
          >
            Salvar t√≥pico
          </button>
        </div>

        <!-- HEADER DA LISTA DE T√ìPICOS -->
        <div class="topicos-header-lista">
          <div>
            <p class="tag-materia">Mat√©ria selecionada</p>
            <h2 class="titulo-topicos subtitulo-materia-direita">
              {{ materiaSelecionada.nome }}
            </h2>
          </div>

          <div class="contador-topicos" *ngIf="topicos.length">
            {{ topicos.length }} t√≥pico(s) raiz
          </div>
        </div>

        <div *ngIf="carregandoTopicos" class="loading">
          Carregando t√≥picos...
        </div>

        <div class="arvore-topicos" *ngIf="!carregandoTopicos">

          <ul class="lista-topicos" *ngIf="topicos.length; else listaVazia">
            <ng-container *ngFor="let t of topicos">
              <ng-container
                *ngTemplateOutlet="topicoTemplate;
                                  context: { $implicit: t, nivel: 0, parentArray: topicos }"
              >
              </ng-container>
            </ng-container>
          </ul>

          <ng-template #listaVazia>
            <p class="vazio">
              Nenhum t√≥pico cadastrado. Comece adicionando um t√≥pico da mat√©ria {{ materiaSelecionada.nome }}.
            </p>
          </ng-template>

        </div>
      </div>

      <ng-template #selecioneMateria>
        <div class="card-body card-sem-materia">
          <p class="vazio">
            Selecione ou salve uma mat√©ria na coluna ao lado para gerenciar seus t√≥picos.
          </p>
        </div>
      </ng-template>
    </section>

  </div>
</div>

<!-- TEMPLATE RECURSIVO PARA √ÅRVORE DE T√ìPICOS -->
<ng-template #topicoTemplate let-topico let-nivel="nivel" let-parentArray="parentArray">
  <li>
    <div
      class="topico-linha"
      [style.paddingLeft.px]="nivel * 18"
      [class.selecionado]="topicoSelecionado === topico"
      (click)="selecionarTopico(topico)"
    >
      <div class="topico-info">
        <span class="badge-nivel"></span>

        <span class="topico-descricao">
          {{ topico.descricao }}
        </span>
      </div>

      <div class="topico-acoes" (click)="$event.stopPropagation()">
        <!-- Excluir t√≥pico -->
        <button
          type="button"
          class="btn-icone"
          (click)="excluirTopico(topico, parentArray)"
          title="Excluir"
        >
          <img src="assets/icons/delete.png" alt="Excluir t√≥pico" class="icone-img" />
        </button>

        <!-- Editar t√≥pico -->
        <button
          type="button"
          class="btn-icone"
          (click)="iniciarEdicaoTopico(topico)"
          title="Editar"
        >
          <img src="assets/icons/edit.png" alt="Editar t√≥pico" class="icone-img" />
        </button>
      </div>
    </div>

    <ul class="lista-topicos-filhos" *ngIf="topico.filhos?.length">
      <ng-container *ngFor="let filho of topico.filhos">
        <ng-container
          *ngTemplateOutlet="topicoTemplate;
                            context: { $implicit: filho, nivel: nivel + 1, parentArray: topico.filhos }"
        >
        </ng-container>
      </ng-container>
    </ul>
  </li>
</ng-template>
