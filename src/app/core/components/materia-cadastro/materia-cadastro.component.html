<div class="page-container">

  <div class="layout">

    <!-- CARD √öNICO: MAT√âRIA + T√ìPICOS EMBUTIDOS -->
    <section class="card materias-card">
      <div class="card-body">

        <!-- ====== CABE√áALHO FIXO (DESCRI√á√ÉO + INPUT + SALVAR) ====== -->
        <div class="cabecalho-fixo">

          <!-- ERRO GLOBAL -->
          <div class="mensagem-erro" *ngIf="mensagemErro">
            {{ mensagemErro }}
          </div>

          <div class="cabecalho-linha-unica">

            <!-- BLOCO DESCRI√á√ÉO / CONTEXTO -->
            <div class="cabecalho-contexto">

              <!-- MODO MAT√âRIA -->
              <ng-container *ngIf="!modoTopicoGlobal">
                <div class="pill-modo pill-materia">Mat√©ria</div>
             
              </ng-container>

              <!-- MODO T√ìPICO / SUBT√ìPICO -->
              <ng-container *ngIf="modoTopicoGlobal">
                <div
                  class="pill-modo"
                  [ngClass]="topicoSelecionado ? 'pill-subtopico' : 'pill-topico'">
                  <ng-container *ngIf="!topicoSelecionado">T√≥pico</ng-container>
                  <ng-container *ngIf="topicoSelecionado">Subt√≥pico</ng-container>
                </div>

                
              </ng-container>

            </div>

            <!-- BLOCO INPUT + BOT√ïES -->
            <div class="cabecalho-input-acoes">

              <!-- ===== MODO MAT√âRIA ===== -->
              <ng-container *ngIf="!modoTopicoGlobal; else blocoTopicoTpl">
                <form
                  [formGroup]="materiaForm"
                  (ngSubmit)="salvarMateria()"
                  class="form-inline">

                  <div class="campo-principal">
                    <input
                      #nomeMateriaInput
                      id="nome"
                      type="text"
                      class="input-text"
                      formControlName="nome"
                      placeholder="Ex: Portugu√™s, Direito Penal, Inform√°tica..." />
                  </div>

                  <div class="acoes-topo">
                    <button
                      type="submit"
                      class="btn primario"
                      [disabled]="salvando">
                      {{ salvando ? 'Salvando...' : 'Salvar' }}
                    </button>

                    <button
                      type="button"
                      class="btn secundario"
                      type="button"
                      (click)="novaMateria()">
                      Nova
                    </button>
                  </div>

                </form>
              </ng-container>

              <!-- ===== MODO T√ìPICO / SUBT√ìPICO ===== -->
              <ng-template #blocoTopicoTpl>
                <div class="form-inline">

                  <div class="campo-principal">
                    <input
                      #novoTopicoInput
                      id="novoTopicoDescricao"
                      type="text"
                      [(ngModel)]="novoTopicoDescricao"
                      name="novoTopicoDescricao"
                      class="input-text"
                      placeholder="Digite o nome do t√≥pico ou subt√≥pico..."
                      [disabled]="!materiaSelecionada"
                      (keyup.enter)="adicionarTopico()" />

                    <div class="hint-campo" *ngIf="!materiaSelecionada">
                      Selecione uma mat√©ria na lista para come√ßar a cadastrar t√≥picos.
                    </div>
                  </div>

                  <div class="acoes-topo">
                    <button
                      type="button"
                      class="btn primario"
                      (click)="adicionarTopico()"
                      [disabled]="!materiaSelecionada">
                      {{ modoEdicaoTopico ? 'Salvar altera√ß√£o' : 'Salvar' }}
                    </button>
                  </div>

                </div>
              </ng-template>

            </div>
          </div>

          <div class="erro" *ngIf="campoInvalido('nome')">
            Informe o nome da mat√©ria (m√°x. 100 caracteres).
          </div>
        </div>
        <!-- ====== FIM CABE√áALHO FIXO ====== -->

        <!-- LISTA DE MAT√âRIAS + T√ìPICOS ABAIXO DA MAT√âRIA -->
        <div class="lista-materias-wrapper">

          <p class="page-subtitle">
            Cadastre suas mat√©rias, organize t√≥picos e subt√≥picos e conecte tudo √† sala de estudo.
          </p>

          <div *ngIf="carregandoMaterias" class="loading">
            Carregando mat√©rias...
          </div>

          <div
            class="tabela-materias-container"
            *ngIf="!carregandoMaterias && materias.length">

            <!-- wrapper para scroll horizontal em telas pequenas -->
            <div class="tabela-scroll">
              <table class="tabela-materias">
                <thead>
                  <tr>
                    <th>Mat√©rias</th>
                    <th class="col-acoes">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody>

                  <ng-container *ngFor="let m of materias">

                    <!-- LINHA PRINCIPAL DA MAT√âRIA -->
                    <tr
                      [class.selecionada]="materiaExpandida?.id === m.id"
                      (click)="toggleMateria(m)">
                      <td>
                        <span
                          class="badge-nivel"
                          [ngClass]="classeSemaforoMateria(m)">
                        </span>
                        <span class="materia-nome">
                          {{ m.nome }}
                        </span>
                      </td>

                      <td class="acoes" (click)="$event.stopPropagation()">

                        <!-- ‚ûï Adicionar t√≥pico -->
                        <button
                          type="button"
                          class="btn-icone"
                          (click)="iniciarCadastroTopico(m)"
                          title="Adicionar t√≥pico">
                          <img
                            src="assets/icons/add.png"
                            alt="Adicionar t√≥pico"
                            class="icone-img" />
                        </button>

                        <!-- üìö Sala de estudo da mat√©ria -->
                        <button
                          type="button"
                          class="btn-icone"
                          (click)="abrirSalaEstudoMateria(m)"
                          title="Sala de estudo">
                          <img
                            src="assets/icons/book.png"
                            alt="Sala de estudo"
                            class="icone-img" />
                        </button>

                        <!-- ‚úèÔ∏è Editar mat√©ria -->
                        <button
                          type="button"
                          class="btn-icone"
                          (click)="editarMateria(m)"
                          title="Editar mat√©ria">
                          <img
                            src="assets/icons/edit.png"
                            alt="Editar mat√©ria"
                            class="icone-img" />
                        </button>

                        <!-- üóëÔ∏è Excluir mat√©ria -->
                        <button
                          type="button"
                          class="btn-icone"
                          (click)="excluirMateria(m)"
                          title="Excluir mat√©ria">
                          <img
                            src="assets/icons/delete.png"
                            alt="Excluir mat√©ria"
                            class="icone-img" />
                        </button>
                      </td>
                    </tr>

                    <!-- LINHA EXPANDIDA COM T√ìPICOS DA MAT√âRIA -->
                    <tr *ngIf="materiaExpandida?.id === m.id">
                      <td colspan="2" class="celula-topicos">
                        <div class="topicos-wrapper">

                          <div *ngIf="carregandoTopicos" class="loading">
                            Carregando t√≥picos...
                          </div>

                          <div class="arvore-topicos" *ngIf="!carregandoTopicos">
                            <ul
                              class="lista-topicos"
                              *ngIf="topicos.length; else listaVazia">
                              <ng-container *ngFor="let t of topicos">
                                <ng-container
                                  *ngTemplateOutlet="topicoTemplate;
                                      context: { $implicit: t, nivel: 0, parentArray: topicos }">
                                </ng-container>
                              </ng-container>
                            </ul>

                            <ng-template #listaVazia>
                              <p class="vazio">
                                Nenhum t√≥pico cadastrado. Comece adicionando um t√≥pico da mat√©ria
                                {{ materiaExpandida?.nome }}.
                              </p>
                            </ng-template>
                          </div>

                        </div>
                      </td>
                    </tr>

                  </ng-container>

                </tbody>
              </table>
            </div>
          </div>

          <p
            *ngIf="!carregandoMaterias && !materias.length"
            class="vazio">
            Nenhuma mat√©ria cadastrada ainda.
          </p>
        </div>
      </div>
    </section>

  </div>
</div>

<!-- TEMPLATE RECURSIVO PARA √ÅRVORE DE T√ìPICOS -->
<ng-template
  #topicoTemplate
  let-topico
  let-nivel="nivel"
  let-parentArray="parentArray">
  <li>
    <div
      class="topico-linha"
      [style.paddingLeft.px]="nivel * 18"
      [class.selecionado]="topicoSelecionado === topico"
      (click)="selecionarTopico(topico)">

      <div class="topico-info">
        <span
          class="badge-nivel"
          [ngClass]="classeSemaforoRevisao(topico)">
        </span>

        <span class="topico-descricao">
          {{ topico.descricao }}
        </span>
      </div>

      <div class="topico-acoes" (click)="$event.stopPropagation()">

        <!-- ‚ûï Adicionar subt√≥pico -->
        <button
          type="button"
          class="btn-icone"
          (click)="iniciarCadastroSubtopico(topico)"
          title="Adicionar subt√≥pico">
          <img
            src="assets/icons/add.png"
            alt="Adicionar subt√≥pico"
            class="icone-img" />
        </button>

        <!-- Excluir t√≥pico -->
        <button
          type="button"
          class="btn-icone"
          (click)="excluirTopico(topico, parentArray)"
          title="Excluir">
          <img
            src="assets/icons/delete.png"
            alt="Excluir t√≥pico"
            class="icone-img" />
        </button>

        <!-- Editar t√≥pico -->
        <button
          type="button"
          class="btn-icone"
          (click)="iniciarEdicaoTopico(topico)"
          title="Editar">
          <img
            src="assets/icons/edit.png"
            alt="Editar t√≥pico"
            class="icone-img" />
        </button>
      </div>

    </div>

    <ul class="lista-topicos-filhos" *ngIf="topico.filhos?.length">
      <ng-container *ngFor="let filho of topico.filhos">
        <ng-container
          *ngTemplateOutlet="topicoTemplate;
              context: { $implicit: filho, nivel: nivel + 1, parentArray: topico.filhos }">
        </ng-container>
      </ng-container>
    </ul>
  </li>
</ng-template>
