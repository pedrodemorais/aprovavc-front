<div class="page-container">

  <h1 class="page-title">Biblioteca de Mat√©rias</h1>

  <div class="mensagem-erro" *ngIf="mensagemErro">
    {{ mensagemErro }}
  </div>

  <div class="layout">

    <!-- CARD √öNICO: MAT√âRIA + T√ìPICOS EMBUTIDOS -->
    <section class="card coluna-esquerda">
      <div class="card-body">

        <!-- ================== TOPO: UM √öNICO CAMPO COMPORTAMENTO DIN√ÇMICO ================== -->
        <ng-container *ngIf="!modoTopicoGlobal; else modoTopicoTpl">

          <!-- MODO MAT√âRIA: usa reactive form -->
          <form [formGroup]="materiaForm" (ngSubmit)="salvarMateria()">

            <!-- STATUS VISUAL DO MODO -->
            <div class="modo-status">
              <span class="chip chip-materia">
                <span class="chip-icon">üìö</span>
                <span>Modo: Mat√©ria</span>
              </span>
              <span class="chip-hint">
                Tudo que voc√™ salvar agora ser√° uma <strong>nova mat√©ria</strong>.
              </span>
            </div>

            <div class="form-group">
              <label for="nome" class="titulo-topicos">
                Nome da mat√©ria <span class="obrigatorio">*</span>
              </label>
              <input
                #nomeMateriaInput
                id="nome"
                type="text"
                class="input-text"
                formControlName="nome"
                placeholder="Ex: Portugu√™s, Direito Penal, Inform√°tica..."
              />

              <div class="erro" *ngIf="campoInvalido('nome')">
                Informe o nome da mat√©ria (m√°x. 100 caracteres).
              </div>
            </div>

            <div class="acoes-form">
              <button type="submit" class="btn primario" [disabled]="salvando">
                {{ salvando ? 'Salvando...' : 'Salvar mat√©ria' }}
              </button>
              <button type="button" class="btn secundario" (click)="novaMateria()">
                Nova mat√©ria
              </button>
            </div>

          </form>
        </ng-container>

        <!-- MODO T√ìPICO: mesmo espa√ßo visual, mas agora o campo serve pra t√≥pico/subt√≥pico -->
        <ng-template #modoTopicoTpl>
          <div class="topo-topico">

            <!-- STATUS VISUAL DO MODO T√ìPICO / SUBT√ìPICO -->
            <div class="modo-status">
              <span
                class="chip"
                [ngClass]="topicoSelecionado ? 'chip-subtopico' : 'chip-topico'"
              >
                <span class="chip-icon">
                  {{ topicoSelecionado ? 'üß©' : 'üìù' }}
                </span>

                <ng-container *ngIf="!topicoSelecionado">
                  Modo: T√≥pico raiz
                </ng-container>
                <ng-container *ngIf="topicoSelecionado">
                  Modo: Subt√≥pico
                </ng-container>
              </span>

              <ng-container *ngIf="materiaExpandida">
                <span
                  class="chip-hint"
                  *ngIf="!topicoSelecionado"
                >
                  O pr√≥ximo item ser√° criado em
                  <strong>{{ materiaExpandida.nome }}</strong>.
                </span>

                <span
                  class="chip-hint"
                  *ngIf="topicoSelecionado"
                >
                  O pr√≥ximo item ser√° filho de
                  <strong>{{ topicoSelecionado.descricao }}</strong>.
                </span>
              </ng-container>
            </div>

            <!-- T√çTULO / CONTEXTO -->
            <div class="cabecalho-topicos">
              <div class="cabecalho-topicos-textos">
                <span class="titulo-topicos" *ngIf="materiaExpandida">
                  <ng-container *ngIf="!topicoSelecionado">
                    T√≥picos de
                    <span class="titulo-colorido">{{ materiaExpandida?.nome }}</span>
                  </ng-container>
               
                </span>
              </div>

            </div>

            <!-- INPUT E BOT√ÉO DO T√ìPICO / SUBT√ìPICO -->
            <div class="novo-topico">
              <input
                #novoTopicoInput
                type="text"
                [(ngModel)]="novoTopicoDescricao"
                placeholder="Digite o nome do t√≥pico ou subt√≥pico..."
                class="input-text"
                name="novoTopicoDescricao"
                [disabled]="!materiaSelecionada"
                (keyup.enter)="adicionarTopico()"
              />

              <button
                type="button"
                class="btn primario btn-novo-topico"
                (click)="adicionarTopico()"
                title="Adicionar"
                [disabled]="!materiaSelecionada"
              >
                {{ modoEdicaoTopico ? 'Salvar altera√ß√£o' : 'Salvar t√≥pico' }}
              </button>
            </div>

          </div>
        </ng-template>

        <!-- ===================================================================== -->
        <hr />

        <!-- LISTA DE MAT√âRIAS + T√ìPICOS ABAIXO DA MAT√âRIA -->
        <div *ngIf="carregandoMaterias" class="loading">
          Carregando mat√©rias...
        </div>

        <table class="tabela-materias" *ngIf="!carregandoMaterias && materias.length">
          <thead>
            <tr>
              <th>Mat√©rias</th>
              <th style="width: 130px;">A√ß√µes</th>
            </tr>
          </thead>
          <tbody>

            <ng-container *ngFor="let m of materias">

              <!-- LINHA PRINCIPAL DA MAT√âRIA -->
              <tr
                [class.selecionada]="materiaExpandida?.id === m.id"
                (click)="toggleMateria(m)"
              >
                <td>{{ m.nome }}</td>
                <td class="acoes" (click)="$event.stopPropagation()">

                  <!-- üìö Sala de estudo da mat√©ria -->
                  <button
                    type="button"
                    class="btn-icone"
                    (click)="abrirSalaEstudoMateria(m)"
                    title="Sala de estudo"
                  >
                    <img src="assets/icons/book.png" alt="Sala de estudo" class="icone-img" />
                  </button>

                  <!-- ‚úèÔ∏è Editar mat√©ria -->
                  <button
                    type="button"
                    class="btn-icone"
                    (click)="editarMateria(m)"
                    title="Editar mat√©ria"
                  >
                    <img src="assets/icons/edit.png" alt="Editar mat√©ria" class="icone-img" />
                  </button>

                  <!-- üóëÔ∏è Excluir mat√©ria -->
                  <button
                    type="button"
                    class="btn-icone"
                    (click)="excluirMateria(m)"
                    title="Excluir mat√©ria"
                  >
                    <img src="assets/icons/delete.png" alt="Excluir mat√©ria" class="icone-img" />
                  </button>
                </td>
              </tr>

              <!-- LINHA EXPANDIDA COM T√ìPICOS DA MAT√âRIA -->
              <tr *ngIf="materiaExpandida?.id === m.id">
                <td colspan="2" class="celula-topicos">
                  <div class="topicos-wrapper">

                    <div *ngIf="carregandoTopicos" class="loading">
                      Carregando t√≥picos...
                    </div>

                    <div class="arvore-topicos" *ngIf="!carregandoTopicos">
                      <ul class="lista-topicos" *ngIf="topicos.length; else listaVazia">
                        <ng-container *ngFor="let t of topicos">
                          <ng-container
                            *ngTemplateOutlet="topicoTemplate;
                                              context: { $implicit: t, nivel: 0, parentArray: topicos }"
                          >
                          </ng-container>
                        </ng-container>
                      </ul>

                      <ng-template #listaVazia>
                        <p class="vazio">
                          Nenhum t√≥pico cadastrado. Comece adicionando um t√≥pico da mat√©ria
                          {{ materiaExpandida?.nome }}.
                        </p>
                      </ng-template>
                    </div>

                  </div>
                </td>
              </tr>

            </ng-container>

          </tbody>
        </table>

        <p *ngIf="!carregandoMaterias && !materias.length" class="vazio">
          Nenhuma mat√©ria cadastrada ainda.
        </p>
      </div>
    </section>

  </div>
</div>

<!-- TEMPLATE RECURSIVO PARA √ÅRVORE DE T√ìPICOS -->
<ng-template #topicoTemplate let-topico let-nivel="nivel" let-parentArray="parentArray">
  <li>
    <div
      class="topico-linha"
      [style.paddingLeft.px]="nivel * 18"
      [class.selecionado]="topicoSelecionado === topico"
      (click)="selecionarTopico(topico)"
    >
      <div class="topico-info">
        <span class="badge-nivel"></span>

        <span class="topico-descricao">
          {{ topico.descricao }}
        </span>
      </div>

      <div class="topico-acoes" (click)="$event.stopPropagation()">
        <!-- Excluir t√≥pico -->
        <button
          type="button"
          class="btn-icone"
          (click)="excluirTopico(topico, parentArray)"
          title="Excluir"
        >
          <img src="assets/icons/delete.png" alt="Excluir t√≥pico" class="icone-img" />
        </button>

        <!-- Editar t√≥pico -->
        <button
          type="button"
          class="btn-icone"
          (click)="iniciarEdicaoTopico(topico)"
          title="Editar"
        >
          <img src="assets/icons/edit.png" alt="Editar t√≥pico" class="icone-img" />
        </button>
      </div>
    </div>

    <ul class="lista-topicos-filhos" *ngIf="topico.filhos?.length">
      <ng-container *ngFor="let filho of topico.filhos">
        <ng-container
          *ngTemplateOutlet="topicoTemplate;
                            context: { $implicit: filho, nivel: nivel + 1, parentArray: topico.filhos }"
        >
        </ng-container>
      </ng-container>
    </ul>
  </li>
</ng-template>
