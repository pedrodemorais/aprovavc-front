<div class="page-container">

  <h1 class="page-title">Biblioteca de Mat√©rias e T√≥picos</h1>

  <div class="mensagem-erro" *ngIf="mensagemErro">
    {{ mensagemErro }}
  </div>

  <div class="layout">

    <!-- COLUNA ESQUERDA: MAT√âRIA -->
    <section class="card coluna-esquerda">

      <form [formGroup]="materiaForm" (ngSubmit)="salvarMateria()" class="card-body">

        <div class="form-group">
          <label for="nome">Nome da mat√©ria <span class="obrigatorio">*</span></label>
          <input
            #nomeMateriaInput
            id="nome"
            type="text"
            class="input-text"
            formControlName="nome"
            placeholder="Ex: Portugu√™s, Direito Penal, Inform√°tica..."
          />

          <div class="erro" *ngIf="campoInvalido('nome')">
            Informe o nome da mat√©ria (m√°x. 100 caracteres).
          </div>
        </div>

        <div class="acoes-form">
          <button type="submit" class="btn primario" [disabled]="salvando">
            {{ salvando ? 'Salvando...' : 'Salvar mat√©ria' }}
          </button>
          <button type="button" class="btn secundario" (click)="novaMateria()">
            Nova mat√©ria
          </button>
        </div>

        <p class="materia-selecionada" *ngIf="materiaSelecionada">
          Mat√©ria selecionada: <strong>{{ materiaSelecionada.nome }}</strong>
        </p>
      </form>

      <hr />

      <h3>Minhas mat√©rias</h3>

      <div *ngIf="carregandoMaterias" class="loading">
        Carregando mat√©rias...
      </div>

      <table class="tabela-materias" *ngIf="!carregandoMaterias && materias.length">
        <thead>
          <tr>
            <th>Nome</th>
            <th style="width: 130px;">A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let m of materias"
            [class.selecionada]="materiaSelecionada?.id === m.id"
          >
            <td (click)="editarMateria(m)">{{ m.nome }}</td>
            <td class="acoes">
              <button
                type="button"
                class="btn-icone"
                (click)="editarMateria(m)"
                title="Editar"
              >
                <img src="assets/icons/book.png" alt="Editar mat√©ria" class="icone-img" />
              </button>

              <button
                type="button"
                class="btn-icone"
                (click)="excluirMateria(m)"
                title="Excluir"
              >
                üóëÔ∏è
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <p *ngIf="!carregandoMaterias && !materias.length" class="vazio">
        Nenhuma mat√©ria cadastrada ainda.
      </p>
    </section>

    <!-- COLUNA DIREITA: T√ìPICOS -->
    <section class="card coluna-direita">

      <div class="card-body" *ngIf="materiaSelecionada; else selecioneMateria">

        <!-- cabe√ßalho contexto -->
        <h2 class="titulo-topicos">
          {{ materiaSelecionada.nome }}
        </h2>
        <p class="subtitulo-topicos">
          Cadastre t√≥picos e subt√≥picos clicando no n√≠vel desejado e usando o campo abaixo.
        </p>

        <!-- contexto de onde ser√° criado o novo t√≥pico -->
        <div class="contexto-topico">
          <span *ngIf="!topicoSelecionado" class="tag-contexto">
            Novo t√≥pico raiz
          </span>
          <span *ngIf="topicoSelecionado" class="tag-contexto tag-sub">
            Novo subt√≥pico de:
            <strong>{{ topicoSelecionado.descricao }}</strong>
          </span>

          <button
            *ngIf="topicoSelecionado"
            type="button"
            class="btn secundario btn-menor"
            (click)="limparTopicoSelecionado()"
          >
            Limpar sele√ß√£o
          </button>
        </div>

        <!-- input √∫nico para t√≥pico / subt√≥pico -->
        <div class="novo-topico">
          <input
            #novoTopicoInput
            type="text"
            [(ngModel)]="novoTopicoDescricao"
            placeholder="Digite o nome do t√≥pico ou subt√≥pico..."
            class="input-text"
            name="novoTopicoDescricao"
          />
          <button type="button" class="btn primario" (click)="adicionarTopico()">
            + Adicionar
          </button>
        </div>

        <div *ngIf="carregandoTopicos" class="loading">
          Carregando t√≥picos...
        </div>

        <div class="arvore-topicos" *ngIf="!carregandoTopicos">

          <ul class="lista-topicos" *ngIf="topicos.length; else listaVazia">
            <ng-container *ngFor="let t of topicos">
              <ng-container
                *ngTemplateOutlet="topicoTemplate;
                                  context: { $implicit: t, nivel: 0, parentArray: topicos }"
              >
              </ng-container>
            </ng-container>
          </ul>

          <ng-template #listaVazia>
            <p class="vazio">
              Nenhum t√≥pico cadastrado. Comece adicionando um t√≥pico raiz.
            </p>
          </ng-template>

         
        </div>
      </div>

      <ng-template #selecioneMateria>
        <div class="card-body">
          <p class="vazio">
            Selecione ou salve uma mat√©ria na coluna ao lado para gerenciar seus t√≥picos.
          </p>
        </div>
      </ng-template>
    </section>

  </div>
</div>

<!-- TEMPLATE RECURSIVO PARA √ÅRVORE DE T√ìPICOS -->
<ng-template #topicoTemplate let-topico let-nivel="nivel" let-parentArray="parentArray">
  <li>
    <div
      class="topico-linha"
      [style.paddingLeft.px]="nivel * 18"
      [class.selecionado]="topicoSelecionado === topico"
      (click)="selecionarTopico(topico)"
    >
      <div class="topico-info">
        <span class="badge-nivel"></span>

        <span class="topico-descricao">
          {{ topico.descricao }}
        </span>
      </div>

      <div class="topico-acoes" (click)="$event.stopPropagation()">
        <button
          type="button"
          class="btn-icone"
          (click)="excluirTopico(topico, parentArray)"
          title="Excluir"
        >
          üóëÔ∏è
        </button>
      </div>
    </div>

    <ul class="lista-topicos-filhos" *ngIf="topico.filhos?.length">
      <ng-container *ngFor="let filho of topico.filhos">
        <ng-container
          *ngTemplateOutlet="topicoTemplate;
                            context: { $implicit: filho, nivel: nivel + 1, parentArray: topico.filhos }"
        >
        </ng-container>
      </ng-container>
    </ul>
  </li>
</ng-template>
