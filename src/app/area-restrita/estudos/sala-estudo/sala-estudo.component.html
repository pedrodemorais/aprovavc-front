<div class="sala-container" *ngIf="!carregando && topico">

    <!-- HEADER -->
    <div class="cabecalho">

        <!-- TITULO -->
        <div class="titulo-sala">
            <h2>
                {{ prova?.nome }}
            </h2>
        </div>

        <div class="bloco-status"></div>
    </div>

    <section class="card header-estudo">
        <!-- Lado direito: badge + modos -->
        <div class="header-actions">
            <div class="botoes">
                <button class="modo-btn" [class.modo-ativo]="modo === 'livre'"
                    (click)="selecionarModo('livre')">
                    üìò Estudo livre
                </button>


                <button class="modo-btn" [class.modo-ativo]="modo === 'pomodoro'" (click)="selecionarModo('pomodoro')"
                    >
                    ‚è± Pomodoro 
                </button>

                <button class="modo-btn" [class.modo-ativo]="modo === 'flashcards'"
                    (click)="selecionarModo('flashcards')" >
                    üß† Revis√£o
                </button>

             
            </div>
        </div>
    </section>
<div class="pomodoro-toast" *ngIf="pomodoroAviso?.aberto" role="status" aria-live="polite">
  <div class="pomodoro-toast__left">
    <div class="pomodoro-toast__title">{{ pomodoroAviso.titulo }}</div>
    <div class="pomodoro-toast__msg">{{ pomodoroAviso.mensagem }}</div>
  </div>

  <button type="button" class="pomodoro-toast__close" (click)="pomodoroAviso.aberto=false" aria-label="Fechar">
    ‚úï
  </button>
</div>
    <!-- MODO LIVRE -->
    <section class="grid" *ngIf="modo === 'livre' || modo === 'pomodoro'">
<!-- TOAST POMODORO -->


        <!-- COLUNA ESQUERDA: NOTAS -->
        <div class="card bloco-notas">

            <div class="notas-header">
                <div class="titulo-notas">
                    <div class="migalha">
                        <ng-container *ngFor="let item of breadcrumb; let i = index">
                            <a class="breadcrumb-link" (click)="abrirTopicoBreadcrumb(item)">
                                {{ item.descricao }}
                            </a>
                            <span class="breadcrumb-separator" *ngIf="i < breadcrumb.length - 1">
                                ‚Ä∫
                            </span>
                        </ng-container>
                    </div>
                </div>

                <div class="bloco-status">
                    <div class="status-botoes">
                        <button class="btn-status btn-cinza" [class.btn-ativo]="estado.status === 'nao_iniciado'"
                            (click)="marcarStatus('nao_iniciado')">
                            N√£o iniciado
                        </button>

                        <button class="btn-status btn-azul" [class.btn-ativo]="estado.status === 'em_estudo'"
                            (click)="marcarStatus('em_estudo')">
                            Em estudo
                        </button>

                        <button class="btn-status btn-verde" [class.btn-ativo]="estado.status === 'concluido'"
                            (click)="marcarStatus('concluido')">
                            Conclu√≠do
                        </button>
                    </div>
                </div>
            </div>

            <!-- EDITOR QUILL -->
            <div class="editor-wrapper" [class.editor-bloqueado]="!editorHabilitado">
                <quill-editor [(ngModel)]="estado.notas" [modules]="quillModules" [formats]="quillFormats"
                    [style]="{ width: '100%' }" theme="snow" class="editor-estudo" [readOnly]="!editorHabilitado">
                </quill-editor>

                <div class="editor-overlay" *ngIf="!editorHabilitado">
                    <span *ngIf="estado.status === 'nao_iniciado'">
                        Clique em <b>Iniciar</b> para estudar
                        <b>{{ (breadcrumb?.length ? breadcrumb[breadcrumb.length - 1]?.descricao : topico?.descricao)
                            }}</b>.
                    </span>

                    <span *ngIf="estado.status === 'pausado'">Estudo <b>pausado</b>. Clique em <b>Retomar</b> para
                        estudar <b>{{ (breadcrumb?.length ? breadcrumb[breadcrumb.length - 1]?.descricao :
                            topico?.descricao) }}</b>..</span>
                    <span *ngIf="estado.status === 'concluido'">T√≥pico <b>conclu√≠do</b>. Para editar, marque <b>Em
                            estudo</b>.</span>
                </div>
            </div>


           <div class="rodape-info">

  <div class="ultima-atualizacao">
    <span *ngIf="estado.ultimaAtualizacao">
      √öltima atualiza√ß√£o:
      {{ estado.ultimaAtualizacao | date:'dd/MM/yyyy HH:mm' }}
    </span>
  </div>

  <!-- ‚úÖ CONTROLES DO TIMER -->
  <div class="controle-estudo">
<button
  class="btn-acao"
  *ngIf="alarmeTocando"
  (click)="pararAlarme()">
  üîá Parar alarme
</button>
<!-- ‚úÖ FLASHCARDS (Sala de Estudos) -->
<button
  class="btn-acao"
  *ngIf="modo === 'livre' || modo === 'pomodoro'"
  (click)="abrirModalFlashcard()">
  ‚ûï Criar Flashcard
</button>



    <button class="btn-acao"
            *ngIf="estado.status !== 'em_estudo' && estado.status !== 'concluido'"
            (click)="iniciarOuRetomar()">
      ‚ñ∂Ô∏è {{
        estado.status === 'pausado'
          ? (modo === 'pomodoro' ? 'Retomar Pomodoro' : 'Retomar')
          : (modo === 'pomodoro' ? 'Iniciar Pomodoro' : 'Iniciar')
      }}
    </button>

    <button class="btn-acao"
            *ngIf="estado.status === 'em_estudo'"
            (click)="pausarEstudo()">
      ‚è∏ Pausar
    </button>

    <!-- opcional (bem √∫til): pular pausa -->
    <button class="btn-acao"
            *ngIf="modo === 'pomodoro' && estado.status === 'em_estudo' && pomodoroEtapa !== 'foco'"
            (click)="pularEtapaPomodoro()">
      ‚è≠ Pular pausa
    </button>

  <button
  type="button"
  class="btn-acao btn-salvar"
  (click)="salvarAgora($event)">
  üíæ Salvar
</button>


    <button class="btn-acao btn-finalizar"
            *ngIf="estado.status !== 'concluido'"
            (click)="concluirEstudo()">
      ‚úÖ Finalizar
    </button>

  </div>

  <!-- ‚úÖ TEMPO -->
  <div class="tempo-estudo" *ngIf="modo === 'livre'">
    Tempo de estudo: <b>{{ tempoFormatado }}</b>
  </div>

  <div class="tempo-estudo" *ngIf="modo === 'pomodoro'">
    <span class="pomodoro-badge">{{ pomodoroEtapaLabel }}</span>
    <b>{{ pomodoroRestanteFormatado }}</b>
    <span class="pomodoro-total">‚Ä¢ Total: <b>{{ tempoFormatado }}</b></span>
  </div>

</div>


        </div>

        <!-- COLUNA DIREITA: SUBT√ìPICOS -->
        <div class="card bloco-lateral">

            <div class="breadcrumb" *ngIf="breadcrumb.length">
                <div class="topico-migalha-de-pao">

                    <div class="migalha">
                        <a class="link-voltar-edital" [routerLink]="['/area-restrita/provas', provaId, 'edital']">
                            {{ prova?.nome }} -
                        </a>

                        <ng-container *ngFor="let item of breadcrumb; let i = index">
                            <a class="breadcrumb-link" (click)="abrirTopicoBreadcrumb(item)">
                                {{ item.descricao }}
                            </a>
                            <span class="breadcrumb-separator" *ngIf="i < breadcrumb.length - 1">
                                ‚Ä∫
                            </span>
                        </ng-container>
                    </div>

                    <div class="bloco-status">
                        <span class="status-pill" [ngClass]="getStatusClass()">
                            {{ getStatusLabel() }}
                        </span>
                    </div>

                </div>
            </div>

            <div class="bloco-subtopicos" *ngIf="subtopicos.length">
                <ul>
                    <li *ngFor="let s of subtopicos" class="subtopico-item" [style.marginLeft.px]="getIndentPx(s)"
                        (click)="abrirSubtopico(s)">

                        <span class="subtopico-descricao">
                            {{ s.descricao }}
                        </span>

                        <span class="subtopico-status-pill" [ngClass]="getStatusClassById(s.id)"
                            (click)="$event.stopPropagation()">
                            {{ getStatusLabelById(s.id) }}
                        </span>

                    </li>
                </ul>

            </div>

            <div class="bloco-subtopicos vazio" *ngIf="!subtopicos.length">
                <p>Sem subt√≥picos cadastrados.</p>
            </div>

        </div>
    </section>
    <!-- ‚úÖ MODAL FLASHCARD -->
<div class="flashcard-modal-backdrop" *ngIf="modalFlashcardAberto" (click)="fecharModalFlashcard()"></div>

<div class="flashcard-modal" *ngIf="modalFlashcardAberto" role="dialog" aria-modal="true">
  <div class="flashcard-modal-header">
    <div class="flashcard-modal-title">Criar Flashcard</div>
    <button type="button" class="flashcard-modal-close" (click)="fecharModalFlashcard()">‚úï</button>
  </div>

  <div class="flashcard-modal-body">
    <!-- Contexto (auto) -->
    <div class="flashcard-context">
      <div><b>Prova:</b> {{ prova?.nome }}</div>
      <div><b>T√≥pico:</b> {{ (breadcrumb?.length ? breadcrumb[breadcrumb.length - 1]?.descricao : topico?.descricao) }}</div>
      <div class="flashcard-context-small">
        <span><b>provaId:</b> {{ provaId }}</span>
        <span><b>topicoId:</b> {{ topicoId }}</span>
      </div>
    </div>

    <!-- Form -->
    <div class="flashcard-form">
      <label class="flashcard-label">Frente (pergunta)</label>
      <textarea class="flashcard-textarea"
        [(ngModel)]="flashcardForm.frente"
        placeholder="Digite a pergunta..."></textarea>

      <label class="flashcard-label">Verso (resposta)</label>
      <textarea class="flashcard-textarea"
        [(ngModel)]="flashcardForm.verso"
        placeholder="Digite a resposta..."></textarea>

      <div class="flashcard-grid">
        <div>
          <label class="flashcard-label">Tipo</label>
          <select class="flashcard-input" [(ngModel)]="flashcardForm.tipo">
            <option value="qa">Pergunta e resposta</option>
            <option value="vf">Certo/Errado</option>
            <option value="cloze" disabled>Cloze (depois)</option>
          </select>
        </div>

        <div>
          <label class="flashcard-label">Dificuldade</label>
          <select class="flashcard-input" [(ngModel)]="flashcardForm.dificuldade">
            <option value="facil">F√°cil</option>
            <option value="media">M√©dia</option>
            <option value="dificil">Dif√≠cil</option>
          </select>
        </div>
      </div>

      <label class="flashcard-label">Tags (opcional)</label>
      <input class="flashcard-input"
        [(ngModel)]="flashcardForm.tags"
        placeholder="Ex.: portugu√™s, morfologia, substantivo" />

      <div class="flashcard-hint">
        Dica: use <b>‚úÇÔ∏è Gerar do trecho</b> para preencher automaticamente a Frente com o texto selecionado.
      </div>
    </div>
  </div>

  <div class="flashcard-modal-footer">
    <button type="button" class="btn-acao" (click)="fecharModalFlashcard()">Cancelar</button>

    <button type="button" class="btn-acao btn-salvar" (click)="salvarFlashcardLocal()">
      üíæ Salvar Flashcard
    </button>
  </div>
</div>

</div>

<div *ngIf="carregando" class="loading">
    Carregando sala de estudo...
</div>